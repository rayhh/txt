# 物理网络中内网PC访问公网--数据包流向

为了更好地理解分层网络和数据包是如何在网络中建立通信连接，本小白梳理了一台普通PC给一个公网IP地址发送UDP数据包所经历的前世今生。

## 构造以太网数据包

首先，该PC会对应用层数据进行封装，我们这里直接进入到传输层；传输层会给该数据包随机分配一个端口用于后续构造五元组。

那为什么要分配端口呢？什么又是五元组呢？

为了理解为什么要分配这个端口，我们将首先理解一下五元组。

#### 五元组

组成：协议号 源端口号 源IP地址 目的端口号 目的IP地址

一个五元组在传输层可以唯一地确定一条逻辑链路，同属一个五元组的数据包将分别在目的和源端的两个七层网络中拥有唯一的socket套接字，数据将通过唯一的逻辑链路在两个socket缓冲区之间进行传输。

​	![](D:\Data\myself\暑期实习求职\实习相关\阿里实习\学习资料\五元组解释.png)

从图中就可以看出，这样一个五元组将可以唯一地把数据包从kernel空间通过socket交给应用程序。

数据包到达IP层之后，如果应用层没有指定从哪个网卡(IP地址)发送数据包，而PC机又有多张网卡的话，那么这时也会由内核随机选择一个网卡接口将数据包发出去；总之，在网络层会添加源IP地址。

#### 区分目的IP地址 局域网内或局域网外

目的IP地址、源IP地址分别与源IP地址的子网掩码做与运算，如果两次与运算的结果一致，则说明源IP和目的IP在同一个网段，不需要过网关。此时，ARP问询报文将直接广播询问目的IP地址对应的MAC地址。如果与运算结果不一致，这说明目的IP地址不在一个网段，数据包需要过网关进行转发，此时ARP问询报文会广播询问网关对应的MAC地址。

拿到MAC地址后，kernel会更新自己的MAC表项，添加“目的IP地址--MAC地址“ 或者 ”网关IP地址--MAC地址“，然后用此MAC地址封装以太网报头。

此时内核的工作就基本结束了，将skb格式的以太网报文进行格式转换之后交给网卡，由网卡将数据bit流通过网线发送出去。

#### 局域网内的传输

以太网数据包将首先被接入层交换机接收，交换机查看到目的MAC地址不是自己（注意：PC看到MAC地址不是自己，又不是广播地址的话，就会直接丢弃，这与交换机不同），就会先将此以太网的源MAC地址修改为交换机的MAC地址，然后将此以太网数据包转发至其他交换机的其他所有端口，这样迭代直到数据包到达网关。

#### 以太网数据包到达网关

首先，什么是网关呢？

网关是一个像路由器一样的实体吗？这个问题对于小白的我，十分困扰。其实后来才明白，网关仅仅只是路由器的一个接口。路由器有很多接口，那么每个接口有可能就充当着不同网段的网关。

区分路由器和网关的概念十分重要。

![网关示例](D:\Data\myself\暑期实习求职\实习相关\阿里实习\学习资料\网关示例.png)

例如局域网A的网关就是路由器R1的f0/0接口，对应IP地址192.168.0.1/24，所以从局域网A出去的数据包经过三层交换机转发之后会到达R1的f0/0接口。

到达f0/0接口之后，会拿到该数据包的目的IP地址；路由器就会根据路由表的item进行逐项匹配，按照最长匹配原则挑选一个出接口。这时，就可以将数据直接转发到该出接口。我觉得这一步十分关键，因为数据包在这一步实现了跨网段传输。



